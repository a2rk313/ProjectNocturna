// js/app.js - FIXED WORKFLOW: SELECT -> ANALYZE
class LightPollutionWebGIS {
    constructor() {
        this.map = null;
        this.mode = null;
        this.dataManager = null;
        this.citizenMode = null;
        this.scientificMode = null;
        this.uiMarkers = new L.LayerGroup();
        this.activeLayers = new Map();
        this.init();
    }

    async init() {
        const urlParams = new URLSearchParams(window.location.search);
        this.mode = urlParams.get('mode') || 'citizen';
        this.showLoadingScreen();
        
        try {
            this.initializeUI();
            await this.initializeMap();
            this.dataManager = new DataManager(this);
            await this.loadLightPollutionData();
            
            if(this.mode === 'citizen') {
                this.citizenMode = new CitizenMode(this);
                this.citizenMode.initialize();
            } else {
                this.scientificMode = new ScientificMode(this);
                this.scientificMode.initialize();
            }
            
            this.setupEventListeners();
            setTimeout(() => this.hideLoadingScreen(), 1000);
        } catch (error) {
            console.error(error);
            this.hideLoadingScreen();
        }
    }

    initializeMap() {
        return new Promise(resolve => {
            this.map = L.map('map', { center: [20, 0], zoom: 3, zoomControl: false });
            L.control.zoom({ position: 'topleft' }).addTo(this.map);
            this.uiMarkers.addTo(this.map);
            this.drawnItems = new L.FeatureGroup().addTo(this.map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
            resolve();
        });
    }

    async loadLightPollutionData() {
        const layer = await this.dataManager.loadVIIRSTileLayer();
        layer.addTo(this.map);
        this.activeLayers.set('viirsLayer', layer);
        
        const darkSky = await this.dataManager.loadGeoServerLayer();
        if(darkSky) {
            darkSky.addTo(this.map);
            this.activeLayers.set('darkSkyParks', darkSky);
        }
    }

    setupEventListeners() {
        ['viirsLayer', 'darkSkyParks', 'groundMeasurements'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('change', (e) => this.toggleLayer(id, e.target.checked));
        });
        
        const bind = (id, fn) => { const el = document.getElementById(id); if(el) el.addEventListener('click', fn); };
        
        // Navigation
        bind('switchMode', () => window.location.href = `index.html?mode=${this.mode === 'citizen' ? 'scientific' : 'citizen'}`);
        bind('clearAll', () => this.clearAll());
        
        // Selection Tools
        bind('drawPolygon', () => this.enableDrawMode());
        bind('dropMarker', () => this.enableMarkerMode());
        
        // Advanced
        bind('planRoute', () => this.enableRoutePlanning());
        bind('compareLocations', () => this.enableCompareMode());
    }

    // --- SELECTION TOOL: DRAW REGION ---
    enableDrawMode() {
        this.clearSelection(); // Clear previous selection first
        this.showMessage('üéØ Draw a polygon on the map to define the target area.');
        new L.Draw.Polygon(this.map).enable();
    }

    // --- SELECTION TOOL: DROP MARKER ---
    enableMarkerMode() {
        this.clearSelection();
        this.showMessage('üìç Click anywhere on the map to pick a location.');
        
        const handler = (e) => {
            const marker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'user-location-pulse',
                    html: '<div style="width: 15px; height: 15px; background: #f59e0b; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(this.uiMarkers);
            
            marker.bindPopup("<strong>Location Selected</strong><br>Now click a tool to analyze.").openPopup();
            this.map.off('click', handler); // One-time click
        };
        this.map.on('click', handler);
    }

    // Handle Completed Drawing
    onDrawCreated(e) {
        const layer = e.layer;
        this.drawnItems.addLayer(layer);
        
        // Instead of auto-analyzing, we confirm selection
        const center = layer.getBounds().getCenter();
        L.popup()
            .setLatLng(center)
            .setContent("<strong>Region Selected</strong><br>Now choose an analysis tool from the menu.")
            .openOn(this.map);
    }

    async toggleLayer(id, visible) {
        if (visible && !this.activeLayers.has(id)) {
            let layer;
            if (id === 'viirsLayer') layer = await this.dataManager.loadVIIRSTileLayer();
            if (id === 'darkSkyParks') layer = await this.dataManager.loadGeoServerLayer();
            if (id === 'groundMeasurements') layer = await this.dataManager.loadGroundMeasurements();
            
            if (layer) { layer.addTo(this.map); this.activeLayers.set(id, layer); }
        } else if (!visible && this.activeLayers.has(id)) {
            this.map.removeLayer(this.activeLayers.get(id));
            this.activeLayers.delete(id);
        }
    }

    enableRoutePlanning() {
        this.showMessage('üó∫Ô∏è Click start and end points.');
        this.routePoints = [];
        const handler = (e) => {
            this.routePoints.push(e.latlng);
            L.marker(e.latlng).addTo(this.uiMarkers);
            if (this.routePoints.length === 2) {
                this.map.off('click', handler);
                this.planRoute();
            }
        };
        this.map.on('click', handler);
    }

    planRoute() {
        if (this.routePoints.length < 2) return;
        this.showMessage('üöó Calculating route...');
        const [start, end] = this.routePoints;
        try {
            L.Routing.control({
                waypoints: [L.latLng(start), L.latLng(end)],
                lineOptions: { styles: [{color: '#60a5fa', opacity: 0.8, weight: 5}] },
                createMarker: function() { return null; }
            }).addTo(this.map);
        } catch(e) { console.error(e); }
    }

    enableCompareMode() {
        this.showMessage('‚öñÔ∏è Click two locations to compare.');
        this.comparisonPoints = [];
        const handler = (e) => {
            L.marker(e.latlng).addTo(this.uiMarkers).bindPopup('Point Selected').openPopup();
            this.comparisonPoints.push(e.latlng);
            if (this.comparisonPoints.length === 2) {
                this.map.off('click', handler);
                this.compareLocations();
            }
        };
        this.map.on('click', handler);
    }

    async compareLocations() {
        const [p1, p2] = this.comparisonPoints;
        const d1 = await this.dataManager.getDataAtPoint(p1.lat, p1.lng);
        const d2 = await this.dataManager.getDataAtPoint(p2.lat, p2.lng);
        
        const content = `
            <h6>‚öñÔ∏è Comparison</h6>
            <table class="table table-sm text-white">
                <tr><th>Metric</th><th>Loc A</th><th>Loc B</th></tr>
                <tr><td>SQM</td><td>${d1.light_pollution.sqm}</td><td>${d2.light_pollution.sqm}</td></tr>
                <tr><td>Bortle</td><td>${d1.light_pollution.bortle.split(' ')[0]}</td><td>${d2.light_pollution.bortle.split(' ')[0]}</td></tr>
            </table>
        `;
        this.showAnalysisPanel('Comparison', content);
        this.comparisonPoints = [];
    }

    clearSelection() {
        this.uiMarkers.clearLayers();
        this.drawnItems.clearLayers();
        if(this.citizenMode) this.citizenMode.userMarker = null;
    }

    clearAll() {
        this.clearSelection();
        if(this.citizenMode) this.citizenMode.clearObservationSpots();
        this.showMessage('üóëÔ∏è Selection cleared.');
    }
    
    showMessage(msg) { L.popup().setLatLng(this.map.getCenter()).setContent(msg).openOn(this.map); }
    
    initializeUI() {
        if (this.mode === 'citizen') {
            document.getElementById('citizenTools').style.display = 'block';
            document.getElementById('scientificTools').style.display = 'none';
        } else {
            document.getElementById('citizenTools').style.display = 'none';
            document.getElementById('scientificTools').style.display = 'block';
        }
    }
    
    showLoadingScreen() { document.getElementById('loadingScreen').style.display='flex'; }
    hideLoadingScreen() { document.getElementById('loadingScreen').style.display='none'; }
    
    showAnalysisPanel(t, c) {
        document.getElementById('analysisTitle').textContent = t;
        document.getElementById('analysisContent').innerHTML = c;
        document.getElementById('analysisPanel').style.display = 'block';
        document.getElementById('closeAnalysis').onclick = () => document.getElementById('analysisPanel').style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', () => { window.webGIS = new LightPollutionWebGIS(); });