version: '3.8'

services:
  db:
    image: docker.io/postgis/postgis:15-3.3
    container_name: projectnocturna_db_1
    restart: always
    # ðŸ‘‡ BYPASS BRIDGE NETWORKING
    network_mode: host
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: nocturna
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Ports are ignored in host mode, but good to keep for reference
    # It will listen on port 5432 of the Debian container directly

  geoserver:
    image: docker.io/kartoza/geoserver:2.24.1
    container_name: projectnocturna_geoserver_1
    restart: always
    # ðŸ‘‡ BYPASS BRIDGE NETWORKING
    network_mode: host
    environment:
      - GEOSERVER_ADMIN_PASSWORD=geoserver
      - GEOSERVER_ADMIN_USER=admin
      - CORS_ENABLED=true
      - CORS_ALLOWED_ORIGINS=*
    volumes:
      - ./geoserver_data:/opt/geoserver/data_dir
    # depends_on doesn't wait for ports in host mode, but helps startup order
    depends_on:
      - db

  app:
    build: .
    container_name: projectnocturna_app_1
    restart: always
    # ðŸ‘‡ BYPASS BRIDGE NETWORKING
    network_mode: host
    depends_on:
      - db
    environment:
      # ðŸ‘‡ HOST IS NOW LOCALHOST because they share the same IP
      - DB_HOST=localhost
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=nocturna
      - DB_PORT=5432
      - NODE_ENV=production

volumes:
  postgres_data: